'use client'

import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react'

export type Locale = 'ca' | 'es' | 'en'

interface I18nContextType {
  locale: Locale
  setLocale: (locale: Locale) => void
  t: (key: string, params?: Record<string, string | number>) => string
  translateText: (text: string, targetLocale?: Locale) => Promise<string>
}

const I18nContext = createContext<I18nContextType | undefined>(undefined)

const translations: Record<Locale, Record<string, string>> = {
  ca: {
    'common.appName': 'Xarxa Anglesola',
    'common.loading': 'Carregant...',
    'common.error': 'Error',
    'common.save': 'Desar',
    'common.cancel': 'Cancel¬∑lar',
    'common.delete': 'Eliminar',
    'common.edit': 'Editar',
    'common.send': 'Enviar',
    'common.close': 'Tancar',
    'common.back': 'Tornar',
    'common.translate': 'Traduir',
    'auth.title': 'Xarxa Anglesola',
    'auth.subtitle': 'Intercanvi de Productes',
    'auth.nickname': 'Usuari',
    'auth.nicknamePlaceholder': 'Introdueix el teu usuari',
    'auth.password': 'Contrasenya',
    'auth.passwordPlaceholder': 'Introdueix la teva contrasenya',
    'auth.confirmPassword': 'Confirma la contrasenya',
    'auth.confirmPasswordPlaceholder': 'Introdueix de nou la contrasenya',
    'auth.email': 'Email',
    'auth.emailPlaceholder': 'Introdueix el teu email',
    'auth.newUser': 'S√≥c un usuari nou',
    'auth.register': 'Registrar-se',
    'auth.nicknameRequired': 'L\'usuari √©s obligatori',
    'auth.passwordRequired': 'La contrasenya √©s obligat√≤ria',
    'auth.confirmPasswordRequired': 'La confirmaci√≥ de contrasenya √©s obligat√≤ria',
    'auth.emailRequired': 'L\'email √©s obligatori',
    'auth.emailInvalid': 'Format d\'email inv√†lid',
    'auth.passwordsDoNotMatch': 'Les contrasenyes no coincideixen',
    'auth.passwordMinLength': 'La contrasenya ha de tenir almenys 6 car√†cters',
    'auth.nicknameMinLength': 'L\'usuari ha de tenir almenys 3 car√†cters',
    'auth.error': 'Error al iniciar sessi√≥',
    'auth.connectionError': 'Error de connexi√≥. Torna-ho a intentar.',
    'auth.enter': 'Entrar',
    'auth.forgotPassword': 'He oblidat la contrasenya',
    'auth.forgotPasswordTitle': 'Recuperar contrasenya',
    'auth.forgotPasswordDescription': 'Introdueix el teu email i t\'enviarem un enlla√ß per restablir la teva contrasenya.',
    'auth.forgotPasswordSuccess': 'Si l\'email existeix, s\'ha enviat un enlla√ß de recuperaci√≥ al teu correu.',
    'auth.forgotPasswordError': 'Error sol¬∑licitant la recuperaci√≥ de contrasenya',
    'auth.sendResetLink': 'Enviar enlla√ß',
    'auth.resetPasswordTitle': 'Restablir contrasenya',
    'auth.resetPasswordDescription': 'Introdueix la teva nova contrasenya',
    'auth.newPassword': 'Nova contrasenya',
    'auth.resetPassword': 'Restablir contrasenya',
    'auth.resetPasswordSuccess': 'Contrasenya restablida correctament. Redirigint...',
    'auth.resetPasswordError': 'Error restablint la contrasenya',
    'auth.invalidToken': 'Token inv√†lid o expirat. Sol¬∑licita un nou enlla√ß de recuperaci√≥.',
    'auth.backToLogin': 'Tornar al login',
    'auth.redirectingToLogin': 'Redirigint al login...',
    'nav.products': 'Productes',
    'nav.favorites': 'Preferits',
    'nav.myProducts': 'Els meus productes',
    'nav.chat': 'Xat General',
    'nav.hello': 'Hola, {nickname}!',
    'nav.logout': 'Sortir',
    'products.title': 'Productes',
    'products.newProduct': '+ Nou Producte',
    'products.noProducts': 'No hi ha productes disponibles',
    'products.publishedBy': 'Publicat per',
    'products.publishedOn': 'Publicat el',
    'products.description': 'Descripci√≥',
    'products.contact': 'Contactar',
    'products.reserved': 'Reservat',
    'products.unreserved': 'Desreservar',
    'products.reserve': 'Reservar',
    'products.prestec': 'Pr√©stec',
    'products.prestecTitle': 'Marcar com a pr√©stec',
    'products.unprestecTitle': 'Desmarcar com a pr√©stec',
    'products.deleteConfirm': 'Est√†s segur que vols eliminar aquest producte?',
    'products.addToFavorites': 'Afegir a preferits',
    'products.removeFromFavorites': 'Eliminar de preferits',
    'products.filters.name': 'Nom del producte',
    'products.filters.user': 'Usuari',
    'products.filters.dateFrom': 'Data des de',
    'products.filters.dateTo': 'Data fins a',
    'products.filters.namePlaceholder': 'Cerca per nom...',
    'products.filters.userPlaceholder': 'Cerca per usuari...',
    'products.filters.clearFilters': 'Esborrar filtres',
    'products.filters.title': 'Filtres',
    'products.showing': 'Mostrant {filtered} de {total} productes',
    'products.noProductsPublished': 'Encara no hi ha productes publicats.',
    'products.beFirst': 'Sigues el primer a publicar un producte!',
    'products.noResults': "No s'han trobat productes amb els filtres seleccionats.",
    'products.deleteProduct': 'Eliminar producte',
    'products.seeMoreDetails': 'Veure m√©s detalls',
    'products.reserveTitle': 'Reservar',
    'products.unreserveTitle': 'Desreservar',
    'products.switchToGridView': 'Canviar a vista grid',
    'products.switchToListView': 'Canviar a vista llista',
    'favorites.title': 'Els meus preferits',
    'favorites.noFavorites': 'Encara no tens cap producte als preferits.',
    'favorites.explore': 'Explora productes ‚Üí',
    'myProducts.title': 'Els meus productes',
    'myProducts.noProducts': 'Encara no has publicat cap producte.',
    'myProducts.publishFirst': 'Publica el teu primer producte ‚Üí',
    'newProduct.title': 'Nou Producte',
    'newProduct.name': 'Nom del producte *',
    'newProduct.namePlaceholder': 'Introdueix el nom del producte',
    'newProduct.description': 'Descripci√≥',
    'newProduct.descriptionPlaceholder': 'Introdueix una descripci√≥ del producte',
    'newProduct.images': 'Imatges (m√†xim 4) *',
    'newProduct.maxImages': 'M√†xim 4 imatges',
    'newProduct.upload': 'Pujar imatge',
    'newProduct.create': 'Publicar Producte',
    'newProduct.publishing': 'Publicant...',
    'newProduct.nameRequired': 'El nom del producte √©s obligatori',
    'newProduct.addImage': 'Afegeix almenys una imatge',
    'newProduct.userNotAuth': 'Usuari no autenticat',
    'newProduct.createError': 'Error al crear el producte',
    'newProduct.connectionError': 'Error de connexi√≥. Torna-ho a intentar.',
    'productDetail.backToProducts': '‚Üê Tornar als productes',
    'productDetail.loading': 'Carregant...',
    'productDetail.notFound': 'Producte no trobat',
    'productDetail.noImage': 'Sense imatge',
    'productDetail.reserved': 'Reservat',
    'productDetail.prestec': 'Pr√©stec',
    'productDetail.description': 'Descripci√≥',
    'productDetail.publishedBy': 'Publicat per',
    'productDetail.publishedOn': 'Publicat el',
    'productDetail.delete': 'Eliminar',
    'productDetail.contact': 'Contactar',
    'chat.general': 'üí¨ Xat General',
    'chat.privateWith': 'Xat amb {nickname}',
    'chat.noMessages': 'No hi ha missatges encara. Sigues el primer a escriure!',
    'chat.writeMessage': 'Escriu un missatge...',
    'chat.writePrivateMessage': 'Escriu un missatge privat...',
    'chat.connecting': 'Connectant...',
    'chat.onlineUsers': 'Usuaris en l√≠nia',
    'chat.noOnlineUsers': 'No hi ha altres usuaris en l√≠nia',
    'chat.closeChat': 'Tancar xat',
    'chat.startPrivateChat': 'Xat privat amb {nickname}',
    'chat.send': 'Enviar',
    'chat.disabledProduction': '‚ö†Ô∏è El xat en temps real no est√† disponible a producci√≥. Socket.io requereix configuraci√≥ addicional.',
    'chat.today': 'Avui',
    'chat.yesterday': 'Ahir',
    'chat.dateSeparator': '{date}',
    'notifications.newMessage': 'Nou missatge',
    'notifications.newPrivateMessage': 'Nou missatge privat',
    'notifications.productReserved': 'Producte reservat',
    'notifications.productReservedMessage': '{nickname} ha reservat el teu producte: {productName}',
    'notifications.productUnreserved': 'Producte desreservat',
    'notifications.productUnreservedMessage': '{nickname} ha desreservat el teu producte: {productName}',
    'notifications.productAddedToFavorites': 'Producte afegit als preferits',
    'notifications.productAddedToFavoritesMessage': '{nickname} ha afegit el teu producte als preferits: {productName}',
    'notifications.sessionTerminated': 'Sessi√≥ tancada',
    'notifications.sessionTerminatedMessage': 'Una nova sessi√≥ s\'ha obert des d\'un altre dispositiu.',
    'notifications.view': 'Veure',
    'notifications.enableNotifications': 'Activar notificacions',
    'notifications.notificationsEnabled': 'Notificacions activades',
    'notifications.notificationsEnabledMessage': 'Ara rebr√†s notificacions del navegador.',
    'notifications.notificationsDisabled': 'Notificacions desactivades',
    'notifications.notificationsDisabledMessage': 'Has denegat els permisos de notificaci√≥. Pots activar-les des de la configuraci√≥ del navegador.',
    'notifications.enabled': 'Notificacions activades',
    'notifications.disableNotifications': 'Desactivar notificacions',
    'notifications.disableInstructions': 'Desactivar notificacions',
    'notifications.disableInstructionsMessage': 'Per desactivar les notificacions, ves a la configuraci√≥ del teu navegador i bloqueja els permisos de notificaci√≥ per a aquest lloc web.',
    'notifications.preferencesTitle': 'Prefer√®ncies de notificacions',
    'notifications.receiveAll': 'Rebre totes les notificacions',
    'notifications.allowedUsersLabel': 'Usuaris permesos',
    'notifications.allowedUsersHint': 'Nicknames separats per comes (ex: xavi, maria)',
    'notifications.allowedProductsLabel': 'Tipus de producte',
    'notifications.allowedProductsHint': 'Paraules clau separades per comes (ex: bici, taula)',
    'notifications.savePreferences': 'Desar prefer√®ncies',
    'notifications.preferencesSaved': 'Prefer√®ncies desades',
    'notifications.preferencesError': 'No s\'han pogut desar les prefer√®ncies',
    'notifications.preferencesLoading': 'Carregant prefer√®ncies...',
  },
  es: {
    'common.appName': 'Xarxa Anglesola',
    'common.loading': 'Cargando...',
    'common.error': 'Error',
    'common.save': 'Guardar',
    'common.cancel': 'Cancelar',
    'common.delete': 'Eliminar',
    'common.edit': 'Editar',
    'common.send': 'Enviar',
    'common.close': 'Cerrar',
    'common.back': 'Volver',
    'common.translate': 'Traducir',
    'auth.title': 'Xarxa Anglesola',
    'auth.subtitle': 'Intercambio de Productos',
    'auth.nickname': 'Usuario',
    'auth.nicknamePlaceholder': 'Introduce tu usuario',
    'auth.password': 'Contrase√±a',
    'auth.passwordPlaceholder': 'Introduce tu contrase√±a',
    'auth.confirmPassword': 'Confirma la contrase√±a',
    'auth.confirmPasswordPlaceholder': 'Introduce de nuevo la contrase√±a',
    'auth.email': 'Email',
    'auth.emailPlaceholder': 'Introduce tu email',
    'auth.newUser': 'Soy un usuario nuevo',
    'auth.register': 'Registrarse',
    'auth.nicknameRequired': 'El usuario es obligatorio',
    'auth.passwordRequired': 'La contrase√±a es obligatoria',
    'auth.confirmPasswordRequired': 'La confirmaci√≥n de contrase√±a es obligatoria',
    'auth.emailRequired': 'El email es obligatorio',
    'auth.emailInvalid': 'Formato de email inv√°lido',
    'auth.passwordsDoNotMatch': 'Las contrase√±as no coinciden',
    'auth.passwordMinLength': 'La contrase√±a debe tener al menos 6 caracteres',
    'auth.nicknameMinLength': 'El usuario debe tener al menos 3 caracteres',
    'auth.error': 'Error al iniciar sesi√≥n',
    'auth.connectionError': 'Error de conexi√≥n. Vuelve a intentarlo.',
    'auth.enter': 'Entrar',
    'auth.forgotPassword': 'He olvidado la contrase√±a',
    'auth.forgotPasswordTitle': 'Recuperar contrase√±a',
    'auth.forgotPasswordDescription': 'Introduce tu email y te enviaremos un enlace para restablecer tu contrase√±a.',
    'auth.forgotPasswordSuccess': 'Si el email existe, se ha enviado un enlace de recuperaci√≥n a tu correo.',
    'auth.forgotPasswordError': 'Error solicitando la recuperaci√≥n de contrase√±a',
    'auth.sendResetLink': 'Enviar enlace',
    'auth.resetPasswordTitle': 'Restablecer contrase√±a',
    'auth.resetPasswordDescription': 'Introduce tu nueva contrase√±a',
    'auth.newPassword': 'Nueva contrase√±a',
    'auth.resetPassword': 'Restablecer contrase√±a',
    'auth.resetPasswordSuccess': 'Contrase√±a restablecida correctamente. Redirigiendo...',
    'auth.resetPasswordError': 'Error restableciendo la contrase√±a',
    'auth.invalidToken': 'Token inv√°lido o expirado. Solicita un nuevo enlace de recuperaci√≥n.',
    'auth.backToLogin': 'Volver al login',
    'auth.redirectingToLogin': 'Redirigiendo al login...',
    'nav.products': 'Productos',
    'nav.favorites': 'Favoritos',
    'nav.myProducts': 'Mis productos',
    'nav.chat': 'Chat General',
    'nav.notes': 'Notas',
    'nav.hello': '¬°Hola, {nickname}!',
    'nav.logout': 'Salir',
    'products.title': 'Productos',
    'products.newProduct': '+ Nuevo Producto',
    'products.noProducts': 'No hay productos disponibles',
    'products.publishedBy': 'Publicado por',
    'products.publishedOn': 'Publicado el',
    'products.description': 'Descripci√≥n',
    'products.contact': 'Contactar',
    'products.reserved': 'Reservado',
    'products.unreserved': 'Desreservar',
    'products.prestec': 'Pr√©stamo',
    'products.prestecTitle': 'Marcar como pr√©stamo',
    'products.unprestecTitle': 'Desmarcar como pr√©stamo',
    'products.reserve': 'Reservar',
    'products.deleteConfirm': '¬øEst√°s seguro de que quieres eliminar este producto?',
    'products.addToFavorites': 'A√±adir a favoritos',
    'products.removeFromFavorites': 'Eliminar de favoritos',
    'products.filters.name': 'Nombre del producto',
    'products.filters.user': 'Usuario',
    'products.filters.dateFrom': 'Fecha desde',
    'products.filters.dateTo': 'Fecha hasta',
    'products.filters.namePlaceholder': 'Buscar por nombre...',
    'products.filters.userPlaceholder': 'Buscar por usuario...',
    'products.filters.clearFilters': 'Borrar filtros',
    'products.filters.title': 'Filtros',
    'products.showing': 'Mostrando {filtered} de {total} productos',
    'products.noProductsPublished': 'A√∫n no hay productos publicados.',
    'products.beFirst': '¬°S√© el primero en publicar un producto!',
    'products.noResults': 'No se han encontrado productos con los filtros seleccionados.',
    'products.deleteProduct': 'Eliminar producto',
    'products.seeMoreDetails': 'Ver m√°s detalles',
    'products.reserveTitle': 'Reservar',
    'products.unreserveTitle': 'Desreservar',
    'favorites.title': 'Mis favoritos',
    'favorites.noFavorites': 'A√∫n no tienes ning√∫n producto en tus favoritos.',
    'favorites.explore': 'Explora productos ‚Üí',
    'myProducts.title': 'Mis productos',
    'myProducts.noProducts': 'A√∫n no has publicado ning√∫n producto.',
    'myProducts.publishFirst': 'Publica tu primer producto ‚Üí',
    'newProduct.title': 'Nuevo Producto',
    'newProduct.name': 'Nombre del producto *',
    'newProduct.namePlaceholder': 'Introduce el nombre del producto',
    'newProduct.description': 'Descripci√≥n',
    'newProduct.descriptionPlaceholder': 'Introduce una descripci√≥n del producto',
    'newProduct.images': 'Im√°genes (m√°ximo 4) *',
    'newProduct.maxImages': 'M√°ximo 4 im√°genes',
    'newProduct.upload': 'Subir imagen',
    'newProduct.create': 'Publicar Producto',
    'newProduct.publishing': 'Publicando...',
    'newProduct.nameRequired': 'El nombre del producto es obligatorio',
    'newProduct.addImage': 'A√±ade al menos una imagen',
    'newProduct.userNotAuth': 'Usuario no autenticado',
    'newProduct.createError': 'Error al crear el producto',
    'newProduct.connectionError': 'Error de conexi√≥n. Vuelve a intentarlo.',
    'productDetail.backToProducts': '‚Üê Volver a los productos',
    'productDetail.loading': 'Cargando...',
    'productDetail.notFound': 'Producto no encontrado',
    'productDetail.noImage': 'Sin imagen',
    'productDetail.reserved': 'Reservado',
    'productDetail.prestec': 'Pr√©stamo',
    'productDetail.description': 'Descripci√≥n',
    'productDetail.publishedBy': 'Publicado por',
    'productDetail.publishedOn': 'Publicado el',
    'productDetail.delete': 'Eliminar',
    'productDetail.contact': 'Contactar',
    'chat.general': 'üí¨ Chat General',
    'chat.privateWith': 'Chat con {nickname}',
    'chat.noMessages': 'No hay mensajes todav√≠a. ¬°S√© el primero en escribir!',
    'chat.writeMessage': 'Escribe un mensaje...',
    'chat.writePrivateMessage': 'Escribe un mensaje privado...',
    'chat.connecting': 'Conectando...',
    'chat.onlineUsers': 'Usuarios en l√≠nea',
    'chat.noOnlineUsers': 'No hay otros usuarios en l√≠nea',
    'chat.closeChat': 'Cerrar chat',
    'chat.startPrivateChat': 'Chat privado con {nickname}',
    'chat.send': 'Enviar',
    'chat.disabledProduction': '‚ö†Ô∏è El chat en tiempo real no est√° disponible en producci√≥n. Socket.io requiere configuraci√≥n adicional.',
    'chat.today': 'Hoy',
    'chat.yesterday': 'Ayer',
    'chat.dateSeparator': '{date}',
    'notifications.newMessage': 'Nuevo mensaje',
    'notifications.newPrivateMessage': 'Nuevo mensaje privado',
    'notifications.productReserved': 'Producto reservado',
    'notifications.productReservedMessage': '{nickname} ha reservado tu producto: {productName}',
    'notifications.productUnreserved': 'Producto desreservado',
    'notifications.productUnreservedMessage': '{nickname} ha desreservado tu producto: {productName}',
    'notifications.productAddedToFavorites': 'Producto a√±adido a favoritos',
    'notifications.productAddedToFavoritesMessage': '{nickname} ha a√±adido tu producto a favoritos: {productName}',
    'notifications.sessionTerminated': 'Sesi√≥n cerrada',
    'notifications.sessionTerminatedMessage': 'Se ha abierto una nueva sesi√≥n desde otro dispositivo.',
    'notifications.view': 'Ver',
    'notifications.enableNotifications': 'Activar notificaciones',
    'notifications.notificationsEnabled': 'Notificaciones activadas',
    'notifications.notificationsEnabledMessage': 'Ahora recibir√°s notificaciones del navegador.',
    'notifications.notificationsDisabled': 'Notificaciones desactivadas',
    'notifications.notificationsDisabledMessage': 'Has denegado los permisos de notificaci√≥n. Puedes activarlas desde la configuraci√≥n del navegador.',
    'notifications.enabled': 'Notificaciones activadas',
    'notifications.disableNotifications': 'Desactivar notificaciones',
    'notifications.disableInstructions': 'Desactivar notificaciones',
    'notifications.disableInstructionsMessage': 'Para desactivar las notificaciones, ve a la configuraci√≥n del navegador y bloquea los permisos de notificaci√≥n para este sitio web.',
    'notifications.preferencesTitle': 'Preferencias de notificaciones',
    'notifications.receiveAll': 'Recibir todas las notificaciones',
    'notifications.allowedUsersLabel': 'Usuarios permitidos',
    'notifications.allowedUsersHint': 'Nicknames separados por comas (ej: xavi, maria)',
    'notifications.allowedProductsLabel': 'Tipo de producto',
    'notifications.allowedProductsHint': 'Palabras clave separadas por comas (ej: bici, mesa)',
    'notifications.savePreferences': 'Guardar preferencias',
    'notifications.preferencesSaved': 'Preferencias guardadas',
    'notifications.preferencesError': 'No se han podido guardar las preferencias',
    'notifications.preferencesLoading': 'Cargando preferencias...',
  },
  en: {
    'common.appName': 'Xarxa Anglesola',
    'common.loading': 'Loading...',
    'common.error': 'Error',
    'common.save': 'Save',
    'common.cancel': 'Cancel',
    'common.delete': 'Delete',
    'common.edit': 'Edit',
    'common.send': 'Send',
    'common.close': 'Close',
    'common.back': 'Back',
    'common.translate': 'Translate',
      'auth.title': 'Xarxa Anglesola',
      'auth.subtitle': 'Product Exchange',
      'auth.nickname': 'Username',
      'auth.nicknamePlaceholder': 'Enter your username',
      'auth.password': 'Password',
      'auth.passwordPlaceholder': 'Enter your password',
      'auth.confirmPassword': 'Confirm password',
      'auth.confirmPasswordPlaceholder': 'Enter password again',
      'auth.email': 'Email',
      'auth.emailPlaceholder': 'Enter your email',
      'auth.newUser': 'I am a new user',
      'auth.register': 'Register',
      'auth.nicknameRequired': 'Username is required',
      'auth.passwordRequired': 'Password is required',
      'auth.confirmPasswordRequired': 'Password confirmation is required',
      'auth.emailRequired': 'Email is required',
      'auth.emailInvalid': 'Invalid email format',
      'auth.passwordsDoNotMatch': 'Passwords do not match',
      'auth.passwordMinLength': 'Password must be at least 6 characters',
      'auth.nicknameMinLength': 'Username must be at least 3 characters',
      'auth.error': 'Login error',
      'auth.connectionError': 'Connection error. Please try again.',
      'auth.enter': 'Enter',
      'auth.forgotPassword': 'Forgot password',
      'auth.forgotPasswordTitle': 'Recover password',
      'auth.forgotPasswordDescription': 'Enter your email and we will send you a link to reset your password.',
      'auth.forgotPasswordSuccess': 'If the email exists, a recovery link has been sent to your email.',
      'auth.forgotPasswordError': 'Error requesting password recovery',
      'auth.sendResetLink': 'Send link',
      'auth.resetPasswordTitle': 'Reset password',
      'auth.resetPasswordDescription': 'Enter your new password',
      'auth.newPassword': 'New password',
      'auth.resetPassword': 'Reset password',
      'auth.resetPasswordSuccess': 'Password reset successfully. Redirecting...',
      'auth.resetPasswordError': 'Error resetting password',
      'auth.invalidToken': 'Invalid or expired token. Request a new recovery link.',
      'auth.backToLogin': 'Back to login',
      'auth.redirectingToLogin': 'Redirecting to login...',
    'nav.products': 'Products',
    'nav.favorites': 'Favorites',
    'nav.myProducts': 'My Products',
    'nav.chat': 'General Chat',
    'nav.notes': 'Notes',
    'nav.hello': 'Hello, {nickname}!',
    'nav.logout': 'Logout',
    'products.title': 'Products',
    'products.newProduct': '+ New Product',
    'products.noProducts': 'No products available',
    'products.publishedBy': 'Published by',
    'products.publishedOn': 'Published on',
    'products.description': 'Description',
    'products.contact': 'Contact',
      'products.reserved': 'Reserved',
      'products.unreserved': 'Unreserve',
      'products.prestec': 'Loan',
      'products.prestecTitle': 'Mark as loan',
      'products.unprestecTitle': 'Unmark as loan',
    'products.reserve': 'Reserve',
    'products.deleteConfirm': 'Are you sure you want to delete this product?',
    'products.addToFavorites': 'Add to favorites',
    'products.removeFromFavorites': 'Remove from favorites',
    'products.filters.name': 'Product name',
    'products.filters.user': 'User',
    'products.filters.dateFrom': 'Date from',
    'products.filters.dateTo': 'Date to',
    'products.filters.namePlaceholder': 'Search by name...',
    'products.filters.userPlaceholder': 'Search by user...',
    'products.filters.clearFilters': 'Clear filters',
    'products.filters.title': 'Filters',
    'products.showing': 'Showing {filtered} of {total} products',
    'products.noProductsPublished': 'No products have been published yet.',
    'products.beFirst': 'Be the first to publish a product!',
    'products.noResults': 'No products found with the selected filters.',
    'products.deleteProduct': 'Delete product',
      'products.seeMoreDetails': 'See more details',
      'products.reserveTitle': 'Reserve',
      'products.unreserveTitle': 'Unreserve',
      'products.switchToGridView': 'Switch to grid view',
      'products.switchToListView': 'Switch to list view',
    'favorites.title': 'My Favorites',
    'favorites.noFavorites': "You don't have any products in your favorites yet.",
    'favorites.explore': 'Explore products ‚Üí',
    'myProducts.title': 'My Products',
    'myProducts.noProducts': "You haven't published any products yet.",
    'myProducts.publishFirst': 'Publish your first product ‚Üí',
    'newProduct.title': 'New Product',
    'newProduct.name': 'Product name *',
    'newProduct.namePlaceholder': 'Enter the product name',
    'newProduct.description': 'Description',
    'newProduct.descriptionPlaceholder': 'Enter a product description',
    'newProduct.images': 'Images (maximum 4) *',
    'newProduct.maxImages': 'Maximum 4 images',
    'newProduct.upload': 'Upload image',
    'newProduct.create': 'Publish Product',
    'newProduct.publishing': 'Publishing...',
    'newProduct.nameRequired': 'Product name is required',
    'newProduct.addImage': 'Add at least one image',
    'newProduct.userNotAuth': 'User not authenticated',
    'newProduct.createError': 'Error creating product',
    'newProduct.connectionError': 'Connection error. Please try again.',
    'productDetail.backToProducts': '‚Üê Back to products',
    'productDetail.loading': 'Loading...',
    'productDetail.notFound': 'Product not found',
    'productDetail.noImage': 'No image',
    'productDetail.reserved': 'Reserved',
    'productDetail.prestec': 'Loan',
    'productDetail.description': 'Description',
    'productDetail.publishedBy': 'Published by',
    'productDetail.publishedOn': 'Published on',
    'productDetail.delete': 'Delete',
    'productDetail.contact': 'Contact',
    'chat.general': 'üí¨ General Chat',
    'chat.privateWith': 'Chat with {nickname}',
    'chat.noMessages': 'No messages yet. Be the first to write!',
    'chat.writeMessage': 'Write a message...',
    'chat.writePrivateMessage': 'Write a private message...',
    'chat.connecting': 'Connecting...',
    'chat.onlineUsers': 'Online users',
    'chat.noOnlineUsers': 'No other users online',
    'chat.closeChat': 'Close chat',
    'chat.startPrivateChat': 'Private chat with {nickname}',
    'chat.send': 'Send',
    'chat.disabledProduction': '‚ö†Ô∏è Real-time chat is not available in production. Socket.io requires additional configuration.',
    'chat.today': 'Today',
    'chat.yesterday': 'Yesterday',
    'chat.dateSeparator': '{date}',
    'notifications.newMessage': 'New message',
    'notifications.newPrivateMessage': 'New private message',
    'notifications.productReserved': 'Product reserved',
    'notifications.productReservedMessage': '{nickname} reserved your product: {productName}',
    'notifications.productUnreserved': 'Product unreserved',
    'notifications.productUnreservedMessage': '{nickname} unreserved your product: {productName}',
    'notifications.productAddedToFavorites': 'Product added to favorites',
    'notifications.productAddedToFavoritesMessage': '{nickname} added your product to favorites: {productName}',
    'notifications.sessionTerminated': 'Session ended',
    'notifications.sessionTerminatedMessage': 'A new session was opened from another device.',
    'notifications.view': 'View',
    'notifications.enableNotifications': 'Enable notifications',
    'notifications.notificationsEnabled': 'Notifications enabled',
    'notifications.notificationsEnabledMessage': 'You will now receive browser notifications.',
    'notifications.notificationsDisabled': 'Notifications disabled',
    'notifications.notificationsDisabledMessage': 'You denied notification permissions. You can enable them in your browser settings.',
    'notifications.enabled': 'Notifications enabled',
    'notifications.disableNotifications': 'Disable notifications',
    'notifications.disableInstructions': 'Disable notifications',
    'notifications.disableInstructionsMessage': 'To disable notifications, go to your browser settings and block notification permissions for this site.',
    'notifications.preferencesTitle': 'Notification preferences',
    'notifications.receiveAll': 'Receive all notifications',
    'notifications.allowedUsersLabel': 'Allowed users',
    'notifications.allowedUsersHint': 'Nicknames separated by commas (e.g., xavi, maria)',
    'notifications.allowedProductsLabel': 'Product type',
    'notifications.allowedProductsHint': 'Keywords separated by commas (e.g., bike, table)',
    'notifications.savePreferences': 'Save preferences',
    'notifications.preferencesSaved': 'Preferences saved',
    'notifications.preferencesError': 'Unable to save preferences',
    'notifications.preferencesLoading': 'Loading preferences...',
  },
}

const formatTranslation = (
  locale: Locale,
  key: string,
  params?: Record<string, string | number>
): string => {
  const translation = translations[locale][key] || key
  if (!params) {
    return translation
  }
  return Object.entries(params).reduce(
    (str, [paramKey, paramValue]) => str.replace(`{${paramKey}}`, String(paramValue)),
    translation
  )
}

export function I18nProvider({ children }: { children: ReactNode }) {
  const [locale, setLocaleState] = useState<Locale>('ca')

  useEffect(() => {
    const savedLocale = localStorage.getItem('locale') as Locale
    if (savedLocale && (savedLocale === 'ca' || savedLocale === 'es' || savedLocale === 'en')) {
      setLocaleState(savedLocale)
    }
  }, [])

  const setLocale = (newLocale: Locale) => {
    setLocaleState(newLocale)
    localStorage.setItem('locale', newLocale)
  }

  const t = (key: string, params?: Record<string, string | number>): string =>
    formatTranslation(locale, key, params)

  const translateText = async (text: string, targetLocale?: Locale): Promise<string> => {
    const target = targetLocale || locale
    
    try {
      // Sense detecci√≥ d'idioma per evitar problemes amb franc en producci√≥
      // Assumir que el text est√† en un idioma diferent al target
      const sourceLang = target === 'ca' ? 'es' : 'ca' // Alternativa simple
      
      // Mapejar els codis d'idioma de l'app als que espera l'API
      const localeMap: Record<Locale, string> = {
        'ca': 'ca',
        'es': 'es',
        'en': 'en'
      }
      
      const targetLang = localeMap[target]
      
      // Si l'idioma detectat ja √©s el mateix que l'objectiu, retornar el text sense canvis
      if (sourceLang === targetLang) {
        return text
      }
      
      // Usar l'API gratu√Øta de MyMemory Translation amb l'idioma detectat
      const response = await fetch(
        `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`
      )
      const data = await response.json()
      if (data.responseData && data.responseData.translatedText) {
        return data.responseData.translatedText
      }
      return text
    } catch (error) {
      console.error('Error translating text:', error)
      return text
    }
  }

  return (
    <I18nContext.Provider value={{ locale, setLocale, t, translateText }}>
      {children}
    </I18nContext.Provider>
  )
}

export function useI18n() {
  const context = useContext(I18nContext)
  if (!context) {
    if (process.env.NODE_ENV !== 'production') {
      console.warn('useI18n must be used within I18nProvider')
    }
    return {
      locale: 'ca' as Locale,
      setLocale: () => {},
      t: (key: string, params?: Record<string, string | number>) =>
        formatTranslation('ca', key, params),
      translateText: async (text: string) => text,
    }
  }
  return context
}

